<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Ning's Salary Â· å°è²“è²“ x å¤§ç‹—ç‹—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #fdfcfb, #f5f7ff);
      --card-bg: #ffffff;
      --accent: #f4a623;           /* å¤§ç‹—ç‹—é‡‘è‰² */
      --accent-soft: rgba(244, 166, 35, 0.1);
      --accent-strong: #c77b00;
      --text-main: #222222;
      --text-muted: #777777;
      --border-subtle: #e6e6ef;
      --danger: #f0625f;
      --pill-bg: #fff8ea;
      --pill-border: rgba(244, 166, 35, 0.4);
    }

    body.dark {
      --bg-gradient: radial-gradient(circle at top, #1f2933, #060b10);
      --card-bg: #111827;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2933;
      --pill-bg: rgba(249, 250, 251, 0.04);
      --pill-border: rgba(249, 250, 251, 0.14);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      padding: 14px;
      display: flex;
      justify-content: center;
    }

    main {
      width: 100%;
      max-width: 560px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span.icon {
      font-size: 1.5rem;
    }

    header p {
      margin: 3px 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .tagline {
      margin-top: 3px;
      font-size: 0.8rem;
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 5px 10px;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    body.dark .theme-toggle {
      background: rgba(15, 23, 42, 0.9);
    }

    .theme-toggle span.icon {
      font-size: 1.1rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 12px;
      margin-bottom: 12px;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
    }

    body.dark .card {
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.45);
      border-color: rgba(15, 23, 42, 0.8);
    }

    .card-title {
      font-size: 0.98rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1 1 150px;
      min-width: 150px;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    input[type="date"],
    input[type="time"],
    input[type="number"],
    input[type="month"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.9rem;
      outline: none;
      background: #fffdf8;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      color: var(--text-main);
    }

    body.dark input[type="date"],
    body.dark input[type="time"],
    body.dark input[type="number"],
    body.dark input[type="month"],
    body.dark select {
      background: #020617;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(244, 166, 35, 0.4);
      background: #ffffff;
    }

    body.dark input:focus,
    body.dark select:focus {
      background: #020617;
    }

    input[type="checkbox"] {
      transform: scale(1.1);
      margin-right: 6px;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      margin-top: 4px;
      color: var(--text-main);
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 9px;
      border-radius: 999px;
      background: var(--pill-bg);
      font-size: 0.8rem;
      color: var(--accent-strong);
      border: 1px solid var(--pill-border);
      white-space: nowrap;
    }

    .pill strong {
      font-weight: 600;
    }

    button {
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.86rem;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), #ffcf71);
      color: #111827;
      box-shadow: 0 5px 14px rgba(244, 166, 35, 0.5);
      justify-content: center;
    }

    body.dark button.primary {
      color: #020617;
    }

    button.primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(244, 166, 35, 0.5);
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
    }

    button.danger {
      background: var(--danger);
      color: #ffffff;
      justify-content: center;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .records-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .record-card {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #fffdf8;
      padding: 6px 8px;
      font-size: 0.78rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    body.dark .record-card {
      background: #020617;
    }

    .record-left {
      flex: 1 1 auto;
      min-width: 0;
    }

    .record-date-line {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
    }

    .record-date-line span.icon {
      font-size: 1rem;
    }

    .record-time {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .record-hours {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .record-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      white-space: nowrap;
    }

    .record-pay {
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--accent-strong);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .record-pay span.icon {
      font-size: 1rem;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .summary-item {
      flex: 1 1 140px;
      min-width: 140px;
      border-radius: 12px;
      background: #fffdf8;
      border: 1px solid var(--border-subtle);
      padding: 6px 8px;
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    body.dark .summary-item {
      background: #020617;
    }

    .summary-item strong {
      font-size: 0.9rem;
    }

    .summary-label {
      color: var(--text-muted);
    }

    .chip-empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      padding-top: 4px;
    }

    .section-label-small {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 8px;
      margin-bottom: 2px;
    }

    .nav-tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 2px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      margin-bottom: 8px;
      gap: 2px;
    }

    body.dark .nav-tabs {
      background: rgba(15, 23, 42, 0.9);
    }

    .nav-tab {
      border-radius: 999px;
      border: none;
      padding: 5px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .nav-tab.active {
      background: var(--accent);
      color: #111827;
      font-weight: 600;
    }

    body.dark .nav-tab.active {
      color: #020617;
    }

    .template-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .template-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fffdf8;
    }

    body.dark .template-pill {
      background: #020617;
    }

    .template-pill span.name {
      font-weight: 600;
    }

    .template-pill button {
      padding: 0 6px;
      font-size: 0.7rem;
      border-radius: 999px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      header h1 {
        font-size: 1.28rem;
      }
      .card {
        padding: 12px 10px;
        border-radius: 16px;
      }
      .row {
        flex-direction: column;
      }
      .field {
        width: 100%;
      }
      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }
      .btn-row button {
        width: 100%;
      }
      .summary-item {
        flex: 1 1 100%;
      }
      .template-pill {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <main>
    <div class="top-bar">
      <header>
        <h1>
          <span class="icon">ğŸ±ğŸ¶</span>
          Ning's Salary
        </h1>
        <p>å°è²“è²“çš„æ‰“å·¥å·¥æ™‚ï¼Œè®“å¤§ç‹—ç‹—å¹«å¦³åˆ‡å¥½åŠ ç­è²»ã€‚</p>
        <div class="tagline">
          <span>â±ï¸</span> 10 åˆ†é˜ä¸€æ ¼ï¼Œè‡ªå‹•åˆ‡ 8h / 9â€“10h / 11h+ï¼Œå«åœ‹å®šå‡æ—¥åŠ ç­ã€‚
        </div>
      </header>
      <button id="themeToggle" class="theme-toggle">
        <span class="icon" id="themeIcon">ğŸŒ</span>
        <span id="themeText">äº®</span>
      </button>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-page="daily"><span>ğŸ“‹</span>æ¯å¤©è¨˜éŒ„</button>
      <button class="nav-tab" data-page="monthly"><span>ğŸ…°ï¸</span>æœˆç¸½è¡¨ A</button>
    </div>

    <section id="pageDaily">
      <section class="card">
        <div class="card-title">
          åŸºæœ¬è¨­å®š
          <span class="badge">Step 0</span>
        </div>
        <div class="row">
          <div class="field">
            <label for="wage">æ™‚è–ªï¼ˆå…ƒï¼‰</label>
            <input type="number" id="wage" value="200" min="0" step="1" />
          </div>
        </div>
        <p class="muted">
          ç›®å‰ä»¥æ¯å°æ™‚ <strong id="wagePreview">200</strong> å…ƒè¨ˆç®—ã€‚èª¿è–ªæ™‚æ”¹é€™è£¡å°±å¥½ã€‚
        </p>
      </section>

      <section class="card">
        <div class="card-title">
          æ’ç­æ¨¡æ¿
          <span class="badge">å¯é¸</span>
        </div>
        <div class="row">
          <div class="field">
            <label for="tplName">ç­åˆ¥åç¨±ï¼ˆä¾‹ï¼šæ—©ç­ã€æ™šç­ï¼‰</label>
            <input type="text" id="tplName" placeholder="æ—©ç­ 10â€“18 / æ™šç­ 15â€“22â€¦" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="tplStart">ä¸Šç­æ™‚é–“</label>
            <input type="time" id="tplStart" step="600" />
          </div>
          <div class="field">
            <label for="tplEnd">ä¸‹ç­æ™‚é–“</label>
            <input type="time" id="tplEnd" step="600" />
          </div>
          <div class="field">
            <label for="tplBreak">ä¼‘æ¯åˆ†é˜æ•¸</label>
            <input type="number" id="tplBreak" value="40" min="0" step="10" />
          </div>
        </div>
        <div class="checkbox-inline">
          <input type="checkbox" id="tplHoliday" />
          <span>åœ‹å®šå‡æ—¥ç­åˆ¥</span>
        </div>
        <div class="btn-row">
          <button class="primary" id="addTplBtn">â• æ–°å¢æ¨¡æ¿</button>
          <span class="muted">é»ä¸‹é¢å°è† å›Šå°±æœƒå¹«å¦³å¸¶å…¥ä»Šå¤©çš„ç­åˆ¥ã€‚</span>
        </div>
        <div class="template-pills" id="templatePills"></div>
      </section>

      <section class="card">
        <div class="card-title">
          ä»Šæ—¥ç­åˆ¥è¼¸å…¥
          <span class="badge">Step 1</span>
        </div>
        <div class="row">
          <div class="field">
            <label for="dateInput">æ—¥æœŸ</label>
            <input type="date" id="dateInput" />
          </div>
          <div class="field">
            <label for="startInput">ä¸Šç­æ™‚é–“ï¼ˆ10 åˆ†é˜åˆ»åº¦ï¼‰</label>
            <input type="time" id="startInput" step="600" />
          </div>
          <div class="field">
            <label for="endInput">ä¸‹ç­æ™‚é–“ï¼ˆ10 åˆ†é˜åˆ»åº¦ï¼‰</label>
            <input type="time" id="endInput" step="600" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="breakInput">ä¼‘æ¯åˆ†é˜æ•¸</label>
            <input type="number" id="breakInput" value="40" min="0" step="10" />
            <div class="muted">ä¼‘æ¯ä¹Ÿæ˜¯ 10 åˆ†é˜ä¸€è·³å°±å¥½ï½</div>
          </div>
          <div class="field" style="align-self:flex-end;">
            <label>&nbsp;</label>
            <div class="checkbox-inline">
              <input type="checkbox" id="holidayInput" />
              <span>åœ‹å®šå‡æ—¥ï¼ˆé›™è–ªï¼‹åŠ ç­ï¼‰</span>
            </div>
            <div class="muted">è¼ªç­æ²’æœ‰é€±ä¼‘ï¼Œåªæœ‰åœ‹å®šå‡æ—¥æ‰ç®—é›™è–ªã€‚</div>
          </div>
        </div>

        <div class="pill-row">
          <div class="pill">
            ğŸ•’ ä»Šæ—¥å·¥æ™‚ï¼š<strong id="todayHoursText">0 å°æ™‚</strong>
          </div>
          <div class="pill">
            ğŸ’° ä»Šæ—¥è–ªæ°´è©¦ç®—ï¼š<strong id="todayPayText">0 å…ƒ</strong>
          </div>
        </div>

        <div class="btn-row">
          <button class="primary" id="addDayBtn">
            â• åŠ å…¥é€™ä¸€å¤©
          </button>
          <span class="muted">
            æœƒå­˜åˆ°ä¸‹é¢ç´€éŒ„ï¼Œä¹‹å¾Œæ‰“é–‹é€™å€‹é é¢ä¹Ÿé‚„åœ¨ã€‚
          </span>
        </div>
      </section>

      <section class="card">
        <div class="card-title">
          ç¸½çµ & ç´€éŒ„
          <span class="badge">Step 2</span>
        </div>

        <div class="summary-row" id="summaryRow" style="display:none;">
          <div class="summary-item">
            <div class="summary-label">åŸºæœ¬å·¥æ™‚ï¼ˆâ‰¤ 8 å°æ™‚ï¼‰</div>
            <strong id="sumBaseHours">0</strong>
            <span class="muted">å°æ™‚</span>
          </div>
          <div class="summary-item">
            <div class="summary-label">ç¬¬ 9ï½10 å°æ™‚</div>
            <strong id="sumOt910">0</strong>
            <span class="muted">å°æ™‚</span>
          </div>
          <div class="summary-item">
            <div class="summary-label">ç¬¬ 11 å°æ™‚èµ·</div>
            <strong id="sumOt11">0</strong>
            <span class="muted">å°æ™‚</span>
          </div>
          <div class="summary-item">
            <div class="summary-label">ç¸½è–ªæ°´</div>
            <strong id="sumTotalPay">0</strong>
            <span class="muted">å…ƒ</span>
          </div>
        </div>

        <p class="muted" style="margin-top:6px;">
          é€™é‚Šæ˜¯ç›®å‰æ‰€æœ‰å·²å„²å­˜çš„ã€Œç¸½å·¥æ™‚ & ç¸½è–ªæ°´ã€ã€‚åˆªæ‰æŸä¸€å¤©ä¹Ÿæœƒå³æ™‚æ›´æ–°ã€‚
        </p>

        <div class="section-label-small">æ¯æ—¥ç´€éŒ„</div>
        <div id="emptyHint" class="chip-empty">
          é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼Œå…ˆåœ¨ä¸Šé¢è¼¸å…¥ä¸€å¤©ç­åˆ¥ï¼ŒæŒ‰ã€ŒåŠ å…¥é€™ä¸€å¤©ã€çœ‹çœ‹å§ã€‚
        </div>

        <div class="records-list" id="recordsList"></div>

        <p class="muted" style="margin-top:6px;">
          æ‰€æœ‰è³‡æ–™åªå­˜åœ¨å¦³é€™æ”¯æ‰‹æ©Ÿï¼é›»è…¦çš„ç€è¦½å™¨è£¡ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•åœ°æ–¹ã€‚
        </p>
      </section>
    </section>

    <section id="pageMonthly" style="display:none;">
      <section class="card">
        <div class="card-title">
          æœˆç¸½è¡¨ A
          <span class="badge">Overview</span>
        </div>
        <div class="row">
          <div class="field">
            <label for="monthInput">é¸æ“‡æœˆä»½</label>
            <input type="month" id="monthInput" />
          </div>
        </div>
        <div class="summary-row" id="monthSummaryRow" style="margin-top:8px;">
          <div class="summary-item">
            <div class="summary-label">æœˆä»½</div>
            <strong id="monthLabel">â€”</strong>
            <span class="muted">yyyy-mm</span>
          </div>
          <div class="summary-item">
            <div class="summary-label">å·¥ä½œå¤©æ•¸</div>
            <strong id="monthWorkDays">0</strong>
            <span class="muted">å¤©</span>
          </div>
          <div class="summary-item">
            <div class="summary-label">ç¸½å·¥æ™‚</div>
            <strong id="monthTotalHours">0</strong>
            <span class="muted">å°æ™‚</span>
          </div>
          <div class="summary-item">
            <div class="summary-label">è©²æœˆç¸½è–ªæ°´</div>
            <strong id="monthTotalPay">0</strong>
            <span class="muted">å…ƒ</span>
          </div>
        </div>
        <p class="muted" style="margin-top:6px;">
          é€™è£¡æœƒä¾ç…§ä¸Šé¢ã€Œæ¯å¤©è¨˜éŒ„ã€çš„è³‡æ–™ï¼Œè‡ªå‹•åŒ¯ç¸½æˆé€™å€‹æœˆçš„å°ç¸½è¡¨ã€‚
        </p>
      </section>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "ningsSalary_v3_dogColor";
    const THEME_KEY = "ningsSalary_theme";

    const wageInput = document.getElementById("wage");
    const wagePreview = document.getElementById("wagePreview");
    const dateInput = document.getElementById("dateInput");
    const startInput = document.getElementById("startInput");
    const endInput = document.getElementById("endInput");
    const breakInput = document.getElementById("breakInput");
    const holidayInput = document.getElementById("holidayInput");

    const todayHoursText = document.getElementById("todayHoursText");
    const todayPayText = document.getElementById("todayPayText");

    const addDayBtn = document.getElementById("addDayBtn");
    const recordsList = document.getElementById("recordsList");

    const sumBaseHoursEl = document.getElementById("sumBaseHours");
    const sumOt910El = document.getElementById("sumOt910");
    const sumOt11El = document.getElementById("sumOt11");
    const sumTotalPayEl = document.getElementById("sumTotalPay");
    const emptyHint = document.getElementById("emptyHint");
    const summaryRow = document.getElementById("summaryRow");

    const themeToggleBtn = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");
    const themeText = document.getElementById("themeText");

    const navTabs = document.querySelectorAll(".nav-tab");
    const pageDaily = document.getElementById("pageDaily");
    const pageMonthly = document.getElementById("pageMonthly");

    const monthInput = document.getElementById("monthInput");
    const monthLabel = document.getElementById("monthLabel");
    const monthWorkDays = document.getElementById("monthWorkDays");
    const monthTotalHours = document.getElementById("monthTotalHours");
    const monthTotalPay = document.getElementById("monthTotalPay");

    const tplNameInput = document.getElementById("tplName");
    const tplStartInput = document.getElementById("tplStart");
    const tplEndInput = document.getElementById("tplEnd");
    const tplBreakInput = document.getElementById("tplBreak");
    const tplHolidayInput = document.getElementById("tplHoliday");
    const addTplBtn = document.getElementById("addTplBtn");
    const templatePills = document.getElementById("templatePills");

    let records = [];
    let templates = [];

    function toMinutes(t) {
      if (!t) return null;
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function roundTo2(x) {
      return Math.round(x * 100) / 100;
    }

    function formatHours(h) {
      return roundTo2(h).toString();
    }

    function formatMoney(n) {
      return Math.round(n).toString();
    }

    function snapTimeTo10Minutes(inputEl) {
      const val = inputEl.value;
      if (!val) return;
      let [h, m] = val.split(":").map(Number);
      let rounded = Math.round(m / 10) * 10;
      if (rounded === 60) {
        h = (h + 1) % 24;
        rounded = 0;
      }
      const hh = String(h).padStart(2, "0");
      const mm = String(rounded).padStart(2, "0");
      inputEl.value = `${hh}:${mm}`;
    }

    // æ­£ç¢ºçš„åŠ ç­ & åœ‹å®šå‡æ—¥è¨ˆç®—
    function calcDayPay(wage, startStr, endStr, breakMin, isHoliday) {
      const startMin = toMinutes(startStr);
      const endMinRaw = toMinutes(endStr);
      const breakMinutes = parseInt(breakMin || "0", 10);

      if (startMin == null || endMinRaw == null || wage <= 0) {
        return {
          valid: false,
          totalHours: 0,
          baseHours: 0,
          ot910: 0,
          ot11: 0,
          pay: 0
        };
      }

      let endMin = endMinRaw;
      if (endMin <= startMin) {
        endMin += 24 * 60;
      }

      let workedMin = endMin - startMin - breakMinutes;
      if (workedMin <= 0) workedMin = 0;

      const totalHours = workedMin / 60;

      const baseHours = Math.min(totalHours, 8);
      let remain = Math.max(totalHours - 8, 0);

      const ot910 = Math.min(remain, 2);
      remain -= ot910;
      const ot11 = Math.max(remain, 0);

      const baseMult = isHoliday ? 2 : 1;

      const basePay = baseHours * wage * baseMult;
      const ot910Pay = ot910 * wage * (baseMult + 0.33);
      const ot11Pay = ot11 * wage * (baseMult + 0.66);

      const pay = basePay + ot910Pay + ot11Pay;

      return {
        valid: true,
        totalHours,
        baseHours,
        ot910,
        ot11,
        pay
      };
    }

    function updateTodayPreview() {
      const wage = parseFloat(wageInput.value) || 0;
      const info = calcDayPay(
        wage,
        startInput.value,
        endInput.value,
        breakInput.value,
        holidayInput.checked
      );
      todayHoursText.textContent = formatHours(info.totalHours) + " å°æ™‚";
      todayPayText.textContent = formatMoney(info.pay) + " å…ƒ";
      addDayBtn.disabled = !info.valid || info.totalHours <= 0;
    }

    function saveToStorage() {
      try {
        const data = {
          wage: parseFloat(wageInput.value) || 0,
          records,
          templates
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error("localStorage error:", e);
      }
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.wage) {
          wageInput.value = data.wage;
          wagePreview.textContent = data.wage;
        }
        if (Array.isArray(data.records)) {
          records = data.records;
        }
        if (Array.isArray(data.templates)) {
          templates = data.templates;
        }
      } catch (e) {
        console.error("localStorage parse error:", e);
      }
    }

    function renderRecords() {
      recordsList.innerHTML = "";

      if (records.length === 0) {
        emptyHint.style.display = "block";
        summaryRow.style.display = "none";
      } else {
        emptyHint.style.display = "none";
        summaryRow.style.display = "flex";
      }

      let sumBase = 0;
      let sum910 = 0;
      let sum11 = 0;
      let sumPay = 0;

      records.forEach((rec, idx) => {
        const card = document.createElement("div");
        card.className = "record-card";

        const left = document.createElement("div");
        left.className = "record-left";

        const dateLine = document.createElement("div");
        dateLine.className = "record-date-line";
        const dateIcon = document.createElement("span");
        dateIcon.className = "icon";
        dateIcon.textContent = "ğŸ“…";
        const dateText = document.createElement("span");
        dateText.textContent = rec.date || "(æœªå¡«æ—¥æœŸ)";
        dateLine.appendChild(dateIcon);
        dateLine.appendChild(dateText);

        const timeEl = document.createElement("div");
        timeEl.className = "record-time";
        timeEl.textContent =
          `${rec.start} ï½ ${rec.end}` + (rec.holiday ? "ï¼ˆåœ‹å‡ï¼‰" : "");

        const hoursEl = document.createElement("div");
        hoursEl.className = "record-hours";
        const totalH = rec.baseHours + rec.ot910 + rec.ot11;
        hoursEl.textContent =
          `ç¸½ ${formatHours(totalH)}hï¼›` +
          `åŸºæœ¬ ${formatHours(rec.baseHours)}h / 9â€“10h ${formatHours(rec.ot910)}h / 11+h ${formatHours(rec.ot11)}h`;

        left.appendChild(dateLine);
        left.appendChild(timeEl);
        left.appendChild(hoursEl);

        const right = document.createElement("div");
        right.className = "record-right";

        const payEl = document.createElement("div");
        payEl.className = "record-pay";
        const payIcon = document.createElement("span");
        payIcon.className = "icon";
        payIcon.textContent = "ğŸ’µ";
        const payText = document.createElement("span");
        payText.textContent = formatMoney(rec.pay) + " å…ƒ";
        payEl.appendChild(payIcon);
        payEl.appendChild(payText);

        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "åˆªé™¤";
        delBtn.addEventListener("click", () => {
          records.splice(idx, 1);
          saveToStorage();
          renderRecords();
          renderMonthlySummary();
        });

        right.appendChild(payEl);
        right.appendChild(delBtn);

        card.appendChild(left);
        card.appendChild(right);
        recordsList.appendChild(card);

        sumBase += rec.baseHours;
        sum910 += rec.ot910;
        sum11 += rec.ot11;
        sumPay += rec.pay;
      });

      sumBaseHoursEl.textContent = formatHours(sumBase);
      sumOt910El.textContent = formatHours(sum910);
      sumOt11El.textContent = formatHours(sum11);
      sumTotalPayEl.textContent = formatMoney(sumPay);
    }

    function renderTemplates() {
      templatePills.innerHTML = "";
      if (templates.length === 0) return;

      templates.forEach((tpl, idx) => {
        const pill = document.createElement("div");
        pill.className = "template-pill";

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = tpl.name || `${tpl.start}-${tpl.end}`;
        const timeSpan = document.createElement("span");
        timeSpan.textContent =
          `${tpl.start}ï½${tpl.end}` +
          (tpl.holiday ? "ãƒ»åœ‹å‡" : "") +
          `ãƒ»ä¼‘ ${tpl.breakMinutes} åˆ†`;

        pill.appendChild(nameSpan);
        pill.appendChild(timeSpan);

        pill.addEventListener("click", (e) => {
          if (e.target.tagName.toLowerCase() === "button") return;
          startInput.value = tpl.start;
          endInput.value = tpl.end;
          breakInput.value = tpl.breakMinutes;
          holidayInput.checked = tpl.holiday;
          updateTodayPreview();
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ•";
        delBtn.title = "åˆªé™¤æ¨¡æ¿";
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          templates.splice(idx, 1);
          saveToStorage();
          renderTemplates();
        });

        pill.appendChild(delBtn);
        templatePills.appendChild(pill);
      });
    }

    function renderMonthlySummary() {
      const monthVal = monthInput.value;
      if (!monthVal) {
        monthLabel.textContent = "â€”";
        monthWorkDays.textContent = "0";
        monthTotalHours.textContent = "0";
        monthTotalPay.textContent = "0";
        return;
      }

      monthLabel.textContent = monthVal;

      const filtered = records.filter((rec) => {
        return rec.date && rec.date.startsWith(monthVal);
      });

      const daySet = new Set();
      let totalHours = 0;
      let totalPay = 0;

      filtered.forEach((rec) => {
        if (rec.date) daySet.add(rec.date);
        const h = rec.baseHours + rec.ot910 + rec.ot11;
        totalHours += h;
        totalPay += rec.pay;
      });

      monthWorkDays.textContent = daySet.size.toString();
      monthTotalHours.textContent = formatHours(totalHours);
      monthTotalPay.textContent = formatMoney(totalPay);
    }

    wageInput.addEventListener("input", () => {
      const v = parseFloat(wageInput.value) || 0;
      wagePreview.textContent = v;
      updateTodayPreview();
      saveToStorage();
    });

    function handleTimeInputSnap() {
      snapTimeTo10Minutes(this);
      updateTodayPreview();
    }

    startInput.addEventListener("change", handleTimeInputSnap);
    startInput.addEventListener("blur", handleTimeInputSnap);
    endInput.addEventListener("change", handleTimeInputSnap);
    endInput.addEventListener("blur", handleTimeInputSnap);

    dateInput.addEventListener("input", updateTodayPreview);
    breakInput.addEventListener("input", updateTodayPreview);
    holidayInput.addEventListener("change", updateTodayPreview);

    addDayBtn.addEventListener("click", () => {
      snapTimeTo10Minutes(startInput);
      snapTimeTo10Minutes(endInput);

      const wage = parseFloat(wageInput.value) || 0;
      const info = calcDayPay(
        wage,
        startInput.value,
        endInput.value,
        breakInput.value,
        holidayInput.checked
      );
      if (!info.valid || info.totalHours <= 0) return;

      const rec = {
        date: dateInput.value || "",
        start: startInput.value || "",
        end: endInput.value || "",
        breakMinutes: parseInt(breakInput.value || "0", 10),
        holiday: holidayInput.checked,
        baseHours: info.baseHours,
        ot910: info.ot910,
        ot11: info.ot11,
        pay: info.pay
      };

      records.push(rec);
      saveToStorage();
      renderRecords();
      renderMonthlySummary();
    });

    addTplBtn.addEventListener("click", () => {
      const name = tplNameInput.value.trim();
      const start = tplStartInput.value;
      const end = tplEndInput.value;
      const breakMinutes = parseInt(tplBreakInput.value || "0", 10);
      const holiday = tplHolidayInput.checked;

      if (!start || !end) return;

      const tpl = {
        name: name || `${start}ï½${end}`,
        start,
        end,
        breakMinutes,
        holiday
      };

      templates.push(tpl);
      saveToStorage();
      renderTemplates();

      tplNameInput.value = "";
    });

    navTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        navTabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");

        const page = tab.getAttribute("data-page");
        if (page === "daily") {
          pageDaily.style.display = "";
          pageMonthly.style.display = "none";
        } else {
          pageDaily.style.display = "none";
          pageMonthly.style.display = "";
          renderMonthlySummary();
        }
      });
    });

    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeIcon.textContent = "ğŸŒ™";
        themeText.textContent = "æš—";
      } else {
        document.body.classList.remove("dark");
        themeIcon.textContent = "ğŸŒ";
        themeText.textContent = "äº®";
      }
    }

    themeToggleBtn.addEventListener("click", () => {
      const current = document.body.classList.contains("dark") ? "dark" : "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
      try {
        localStorage.setItem(THEME_KEY, next);
      } catch (e) {
        console.error(e);
      }
    });

    (function initTheme() {
      let stored = null;
      try {
        stored = localStorage.getItem(THEME_KEY);
      } catch (e) {}
      const theme = stored || "light";
      applyTheme(theme);
    })();

    (function initDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
      monthInput.value = `${yyyy}-${mm}`;
    })();

    loadFromStorage();
    renderTemplates();
    renderRecords();
    updateTodayPreview();
    renderMonthlySummary();
  </script>
</body>
</html>
